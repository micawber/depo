yum install -y bash-completion net-tools dbus curl wget mc nc vim dos2unix ntsysv sysfsutils bind-utils yum-utils nfs-utils samba samba-winbind-clients sysstat tcpdump libXtst xterm dnsmasq fuse fuse3 chrony nscd open-vm-tools jq mailcap lvm2 udev udica libnsl libtirpc selinu* libseccomp nginx dmidecode ipmitool s-nail podman podman-plugins python3-dateutil libxcrypt-compat git python3-magic python3-libguestfs fio
yum install -y adcli realmd sssd oddjob oddjob-mkhomedir samba-common-tools krb5-workstation authselect-compat

ln -s /usr/lib64/libncurses.so.6.2 /usr/lib64/libncurses.so.5
ln -s /usr/lib64/libtinfo.so.6.2 /usr/lib64/libtinfo.so.5

cat <<'EOF' | sed -i "7r /dev/stdin" /etc/inputrc
set enable-bracketed-paste off
EOF

cat <<EOT>> /root/.bashrc
alias vi='vim'
EOT

cat <<EOT>> /root/.bash_profile
$(echo)
PATH=\$PATH:\$HOME/bin:/usr/openv/netbackup/bin:/usr/openv/netbackup/bin/admincmd:/usr/openv/netbackup/bin/goodies:/usr/openv/volmgr/bin:/usr/openv/pdde/pdcr/bin:/usr/openv/pdde/pdag/bin:/usr/openv/pdde/vpfs/bin:/opt/VRTS/bin:/opt/VRTSvcs/bin
export PATH
export GREP_COLOR='1;31'
export PS1="\[\e[1;33m\]\u\[\e[m\]@\[\e[1;34m\]\h\[\e[m\]:\$PWD> "
EOT

echo "insecure" >> $HOME/.curlrc
echo ":set hlsearch" >> .vimrc
echo ":set ic" >> .vimrc
echo ":set number" >> .vimrc
echo ":colo elflord" >> .vimrc
echo ":syntax on" >> .vimrc

sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

systemctl stop firewalld
systemctl disable firewalld

cat <<EOT>> /etc/security/limits.conf
*      soft    core           unlimited
*      hard    core           unlimited
*      soft    nofile         32768
*      hard    nofile         63535
*      soft    stack          32768
*      hard    stack          63535
EOT

echo "kernel.sem = 400 307200 128 1024" >> /etc/sysctl.conf
echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
echo "net.core.rmem_max = 1073741824" >> /etc/sysctl.conf
echo "net.core.wmem_max = 1073741824" >> /etc/sysctl.conf
echo "net.core.rmem_default = 524288" >> /etc/sysctl.conf
echo "net.core.wmem_default = 524288" >> /etc/sysctl.conf
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.core.netdev_max_backlog = 30000" >> /etc/sysctl.conf
echo "net.ipv4.tcp_rmem = 524288 524288 1073741824" >> /etc/sysctl.conf
echo "net.ipv4.tcp_wmem = 524288 524288 1073741824" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_time = 700" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_probes = 20" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_intvl = 10" >> /etc/sysctl.conf
echo "net.ipv4.tcp_fin_timeout = 5" >> /etc/sysctl.conf
echo "vm.swappiness = 1" >> /etc/sysctl.conf
echo "vm.overcommit_memory = 0" >> /etc/sysctl.conf
echo "vm.overcommit_ratio = 100" >> /etc/sysctl.conf
echo "vm.nr_hugepages = 0" >> /etc/sysctl.conf
echo "vm.zone_reclaim_mode = 0" >> /etc/sysctl.conf
echo "vm.extfrag_threshold = 1000" >> /etc/sysctl.conf
echo "vm.vfs_cache_pressure = 200" >> /etc/sysctl.conf
echo "fs.inotify.max_user_watches = 32768" >> /etc/sysctl.conf
echo "fs.file-max = 1638400" >> /etc/sysctl.conf
echo "fs.leases-enable = 0" >> /etc/sysctl.conf
echo "kernel.numa_balancing = 0" >> /etc/sysctl.conf
sysctl -p

mkdir /usr/openv

### PRIMARY SERVER KURULUMU DURUMUNDA GEREKLİDİR ###
groupadd -g 1111 nbwebgrp
useradd -c 'NetBackup Web Services Account' -g 1111 -u 1111 -d /usr/openv/wmc nbwebsvc
usermod -s /sbin/nologin nbwebsvc

groupadd -g 1112 nbsvcusr
useradd -c 'NetBackup Service Account' -g 1112 -u 1112 nbsvcusr
usermod -s /sbin/nologin nbsvcusr
usermod -a -G nbwebgrp nbsvcusr
### PRIMARY SERVER KURULUMU DURUMUNDA GEREKLİDİR ###

### Concat Volume on NVMe ###
mkdir /MSDP
parted --script /dev/nvme0n2 unit GiB mklabel gpt mkpart primary 0% 100%
pvcreate /dev/nvme0n2p1
vgcreate vg_nbu_msdp /dev/nvme0n2p1
lvcreate -l 100%FREE -n vol1 vg_nbu_msdp
mkfs.xfs /dev/vg_nbu_msdp/vol1
echo -e "/dev/vg_nbu_msdp/vol1\t/MSDP\txfs\tdefaults\t0 0" >> /etc/fstab
systemctl daemon-reload
mount -a
